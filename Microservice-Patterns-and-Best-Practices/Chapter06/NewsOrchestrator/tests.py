import os
import pytest
from .service import Command
from nameko.testing.services import worker_factory
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker


@pytest.fixture
def session():
    db_engine = create_engine(os.environ.get('COMMANDDB_TEST_HOST'))
    Session = sessionmaker(db_engine)
    return Session()


def test_command(session):
    data = {
        "title": "title test",
        "author": "author test",
        "content": "content test",
        "tags": [
            "test tag1",
            "test tag2",
        ],
    }
    command = worker_factory(Command, db=session)
    result = command.add_news(data)
    assert result['title'] == "title test"
    assert result['version'] == 1

    data['id'] = result['id']
    data['version'] = result['version']
    command = worker_factory(Command, db=session)
    result = command.add_news(data)
    assert result['version'] == 2


# integration tests
class TestNewsService(BaseTestCase):

    # test if we can add news from the level of orchestrator
    def test_add_news(self):
        """Test to insert a News to the database."""
        with self.client:
            # go to route 'POST /famous' with data 
            response = self.client.post(
                '/famous',
                data=json.dumps(dict(
                    title='My Test',
                    content='Just a service test',
                    author='unittest',
                    tags=['Test', 'Functional_test'],
                )),
                content_type='application/json',
            )
            # get response
            data = json.loads(response.data.decode())
            # check response
            self.assertEqual(response.status_code, 201)
            self.assertIn('success', data['status'])
            self.assertIn('My Test', data['news']['title'])

    # test if we can get all news from the level of orchestrator
    def test_get_all_news(self):
        """Test to get all News paginated from the database."""
        with self.client:
            test_cases = [
                {'page': 1, 'num_per_page': 10, 'loop_couter': 0},
                {'page': 2, 'num_per_page': 10, 'loop_couter': 10},
                {'page': 1, 'num_per_page': 20, 'loop_couter': 0},
            ]
            for tc in test_cases:
                # go to route i.e. 'GET /famous/1/10'
                response = self.client.get(
                    '/famous/{}/{}'.format(
                        tc['page'], tc['num_per_page'])
                )
                # get response
                data = json.loads(response.data.decode())
                # check response
                self.assertEqual(response.status_code, 200)
                self.assertIn('success', data['status'])
                self.assertEqual(len(data['news']) > 0)
                for d in data['news']:
                    self.assertEqual(
                        d['title'],
                        'Title test-{}'.format(tc['loop_couter'])
                    )
                    self.assertEqual(
                        d['content'],
                        'Content test-{}'.format(tc['loop_couter'])
                    )
                    self.assertEqual(
                        d['author'],
                        'Author test-{}'.format(tc['loop_couter'])
                    )
                    tc['loop_couter'] += 1
